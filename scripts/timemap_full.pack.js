/* 
 * Timemap.js Copyright 2008 Nick Rabinowitz.
 * Licensed under the MIT License (see LICENSE.txt)
 */
var DT=Timeline.DateTime,GIP="http://www.google.com/intl/en_us/mapfiles/ms/icons/";function TimeMap(b,e,c){var a=TimeMap.util;this.mElement=e;this.tElement=b;this.datasets={};this.chains={};this.mapBounds=new GLatLngBounds();var g={mapCenter:new GLatLng(0,0),mapZoom:0,mapType:G_PHYSICAL_MAP,mapTypes:[G_NORMAL_MAP,G_SATELLITE_MAP,G_PHYSICAL_MAP],showMapTypeCtrl:true,showMapCtrl:true,syncBands:true,mapFilter:"hidePastFuture",centerOnItems:true,theme:"red"};this.opts=c=a.merge(c,g);c.mergeOnly=["mergeOnly","theme","eventIconPath","openInfoWindow","closeInfoWindow","noPlacemarkLoad","noEventLoad"];c.mapType=a.lookup(c.mapType,TimeMap.mapTypes);c.mapFilter=a.lookup(c.mapFilter,TimeMap.filters);c.theme=TimeMapTheme.create(c.theme,c);if(GBrowserIsCompatible()){this.map=new GMap2(this.mElement);var f=this.map;if(c.showMapCtrl){f.addControl(new GLargeMapControl())}if(c.showMapTypeCtrl){f.addControl(new GMapTypeControl())}var d;for(d=G_DEFAULT_MAP_TYPES.length-1;d>0;d--){f.removeMapType(G_DEFAULT_MAP_TYPES[d])}f.addMapType(c.mapTypes[0]);f.removeMapType(G_DEFAULT_MAP_TYPES[0]);for(d=1;d<c.mapTypes.length;d++){f.addMapType(c.mapTypes[d])}f.enableDoubleClickZoom();f.enableScrollWheelZoom();f.enableContinuousZoom();f.setCenter(c.mapCenter,c.mapZoom);f.setMapType(c.mapType)}}TimeMap.version="1.6pre";TimeMap.init=function(c){var m=TimeMap.util;var i="TimeMap.init: No id for ";if(!("mapId" in c)||!c.mapId){throw i+"map"}if(!("timelineId" in c)||!c.timelineId){throw i+"timeline"}var h={options:{},datasets:[],bands:false,bandInfo:false,bandIntervals:"wk",scrollTo:"earliest"};c=m.merge(c,h);if(!c.bandInfo&&!c.bands){var l=m.lookup(c.bandIntervals,TimeMap.intervals);c.bandInfo=[{width:"80%",intervalUnit:l[0],intervalPixels:70},{width:"20%",intervalUnit:l[1],intervalPixels:100,showEventText:false,overview:true,trackHeight:0.4,trackGap:0.2}]}var p=new TimeMap(document.getElementById(c.timelineId),document.getElementById(c.mapId),c.options);var j=[],o,b,e,g,a;for(o=0;o<c.datasets.length;o++){b=c.datasets[o];g={title:b.title,theme:b.theme,dateParser:b.dateParser};e=m.merge(b.options,g);a=b.id||"ds"+o;j[o]=p.createDataset(a,e);if(o>0){j[o].eventSource=j[0].eventSource}}p.eventSource=j[0].eventSource;var f=[];var d=(j[0]&&j[0].eventSource)||new Timeline.DefaultEventSource();if(c.bands){f=c.bands;for(o=0;o<f.length;o++){if(f[o].eventSource!==null){f[o].eventSource=d}}}else{for(o=0;o<c.bandInfo.length;o++){var n=c.bandInfo[o];if(!(("eventSource" in n)&&!n.eventSource)){n.eventSource=d}else{n.eventSource=null}f[o]=Timeline.createBandInfo(n);if(o>0&&m.TimelineVersion()=="1.2"){f[o].eventPainter.setLayout(f[0].eventPainter.getLayout())}}}p.initTimeline(f);var k=TimeMap.loadManager;k.init(p,c.datasets.length,c);for(o=0;o<c.datasets.length;o++){(function(r){var v=c.datasets[r],s,u,w,t,q;s=v.data||v.options||{};u=v.type||s.type;w=function(){k.increment()};t=(typeof(u)=="string")?TimeMap.loaders[u]:u;q=new t(s);q.load(j[r],w)})(o)}return p};var timemapInit=TimeMap.init;TimeMap.loadManager=new function(){this.init=function(a,c,b){this.count=0;this.tm=a;this.target=c;this.opts=b||{}};this.increment=function(){this.count++;if(this.count>=this.target){this.complete()}};this.complete=function(){var a=this.tm;var c=this.opts.dataLoadedFunction;if(c){c(a)}else{var f=new Date();var e=this.tm.eventSource;var b=this.opts.scrollTo;if(b&&e.getCount()>0){switch(b){case"now":break;case"earliest":f=e.getEarliestDate();break;case"latest":f=e.getLatestDate();break;default:if(typeof(b)=="string"){b=TimeMapDataset.hybridParser(b)}if(b.constructor==Date){f=b}}a.timeline.getBand(0).setCenterVisibleDate(f)}a.timeline.layout();c=this.opts.dataDisplayedFunction;if(c){c(a)}}}};TimeMap.loaders={};TimeMap.loaders.basic=function(a){TimeMap.loaders.mixin(this,a);this.data=a.items||a.value||[]};TimeMap.loaders.basic.prototype.load=function(b,c){var a=this.preload(this.data);b.loadItems(a,this.transform);c()};TimeMap.loaders.remote=function(a){TimeMap.loaders.mixin(this,a);this.url=a.url};TimeMap.loaders.remote.prototype.load=function(b,c){var a=this;GDownloadUrl(this.url,function(d){var e=a.parse(d);e=a.preload(e);b.loadItems(e,a.transform);c()})};TimeMap.loaders.mixin=function(a,b){var c=function(d){return d};a.parse=b.parserFunction||c;a.preload=b.preloadFunction||c;a.transform=b.transformFunction||c};TimeMap.prototype.createDataset=function(d,b){var c=new TimeMapDataset(this,b);this.datasets[d]=c;if(this.opts.centerOnItems){var a=this;GEvent.addListener(c,"itemsloaded",function(){var f=a.map,e=a.mapBounds;f.setZoom(f.getBoundsZoomLevel(e));f.setCenter(e.getCenter())})}return c};TimeMap.prototype.each=function(a){for(var b in this.datasets){if(this.datasets.hasOwnProperty(b)){a(this.datasets[b])}}};TimeMap.prototype.eachItem=function(a){this.each(function(b){b.each(function(c){a(c)})})};TimeMap.prototype.getItems=function(b){var a=[];this.eachItem(function(c){a.push(c)});return a};TimeMap.prototype.initTimeline=function(e){for(var a=1;a<e.length;a++){if(this.opts.syncBands){e[a].syncWith=(a-1)}e[a].highlight=true}this.timeline=Timeline.create(this.tElement,e);var c=this;this.timeline.getBand(0).addOnScrollListener(function(){c.filter("map")});var b=this.timeline.getBand(0).getEventPainter().constructor;b.prototype._showBubble=function(g,i,h){h.item.openInfoWindow()};this.addFilterChain("map",function(g){g.showPlacemark()},function(g){g.hidePlacemark()});this.addFilter("map",function(g){return g.visible});this.addFilter("map",function(g){return g.dataset.visible});this.addFilter("map",this.opts.mapFilter);this.addFilterChain("timeline",function(g){g.showEvent()},function(g){g.hideEvent()});this.addFilter("timeline",function(g){return g.visible});this.addFilter("timeline",function(g){return g.dataset.visible});var f=null;var d=this.timeline;window.onresize=function(){if(f===null){f=window.setTimeout(function(){f=null;d.layout()},500)}}};TimeMap.prototype.filter=function(c){var b=this.chains[c],a;if(!b){return}a=b.chain;if(!a||a.length===0){return}this.each(function(d){d.each(function(g){var e=false;F_LOOP:while(!e){for(var f=a.length-1;f>=0;f--){if(!a[f](g)){b.off(g);break F_LOOP}}b.on(g);e=true}})})};TimeMap.prototype.addFilterChain=function(c,b,a){this.chains[c]={chain:[],on:b,off:a}};TimeMap.prototype.removeFilterChain=function(a){this.chains[a]=null};TimeMap.prototype.addFilter=function(c,b){var a=this.chains[c];if(a&&a.chain){a.chain.push(b)}};TimeMap.prototype.removeFilter=function(e,d){var c=this.chains[e];if(c&&c.chain){var b=c.chain;if(!d){b.pop()}else{for(var a=0;a<b.length;a++){if(b[a]==d){b.splice(a,1)}}}}};TimeMap.filters={};TimeMap.filters.hidePastFuture=function(d){var f=d.dataset.timemap.timeline.getBand(0);var b=f.getMaxVisibleDate().getTime();var c=f.getMinVisibleDate().getTime();if(d.event){var a=d.event.getStart().getTime();var e=d.event.getEnd().getTime();if(a>b){return false}else{if(e<c||(d.event.isInstant()&&a<c)){return false}}}return true};TimeMap.filters.showMomentOnly=function(b){var d=b.dataset.timemap.timeline.getBand(0);var e=d.getCenterVisibleDate().getTime();if(b.event){var a=b.event.getStart().getTime();var c=b.event.getEnd().getTime();if(a>e){return false}else{if(c<e||(b.event.isInstant()&&a<e)){return false}}}return true};function TimeMapDataset(b,c){var a=TimeMap.util;this.timemap=b;this.eventSource=new Timeline.DefaultEventSource();this.items=[];this.visible=true;var d={title:"Untitled",dateParser:TimeMapDataset.hybridParser};this.opts=c=a.merge(c,d,b.opts);c.dateParser=a.lookup(c.dateParser,TimeMap.dateParsers);c.theme=TimeMapTheme.create(c.theme,c);this.getItems=function(e){if(e!==undefined){if(e<this.items.length){return this.items[e]}else{return null}}return this.items};this.getTitle=function(){return this.opts.title}}TimeMapDataset.gregorianParser=function(b){if(!b){return null}else{if(b instanceof Date){return b}}var c=Boolean(b.match(/b\.?c\.?/i));var a=parseInt(b,10);if(!isNaN(a)){if(c){a=1-a}var e=new Date(0);e.setUTCFullYear(a);return e}else{return null}};TimeMapDataset.hybridParser=function(a){var c=new Date(Date.parse(a));if(isNaN(c)){if(typeof(a)=="string"){if(a.match(/^-?\d{1,6} ?(a\.?d\.?|b\.?c\.?e?\.?|c\.?e\.?)?$/i)){c=TimeMapDataset.gregorianParser(a)}else{try{c=DT.parseIso8601DateTime(a)}catch(b){c=null}}}else{return null}}return c};TimeMapDataset.prototype.each=function(b){for(var a=0;a<this.items.length;a++){b(this.items[a])}};TimeMapDataset.prototype.loadItems=function(c,b){for(var a=0;a<c.length;a++){this.loadItem(c[a],b)}GEvent.trigger(this,"itemsloaded")};TimeMapDataset.prototype.loadItem=function(A,q){var a=TimeMap.util;if(q!==undefined){A=q(A)}if(!A){return}options=a.merge(A.options,this.opts);var z=options.theme=TimeMapTheme.create(options.theme,options);var f=this.opts.dateParser,l=A.start,j=A.end,e;l=l?f(l):null;j=j?f(j):null;e=!j;var d=z.eventIcon,B=A.title,v=null;if(l!==null){var n=Timeline.DefaultEventSource.Event;if(a.TimelineVersion()=="1.2"){v=new n(l,j,null,null,e,B,null,null,null,d,z.eventColor,z.eventTextColor)}else{var k=z.eventTextColor;if(!k){k=(z.classicTape&&!e)?"#FFFFFF":"#000000"}v=new n({start:l,end:j,instant:e,text:B,icon:d,color:z.eventColor,textColor:k})}}var b=z.icon,g=this.timemap,m=g.mapBounds;var s=function(E){var D=null,G="",J=null;if(E.point){var F=E.point.lat,p=E.point.lon;if(F===undefined||p===undefined){return null}J=new GLatLng(parseFloat(E.point.lat),parseFloat(E.point.lon));if(g.opts.centerOnItems){m.extend(J)}D=new GMarker(J,{icon:b});G="marker";J=D.getLatLng()}else{if(E.polyline||E.polygon){var K=[],L;if(E.polyline){L=E.polyline}else{L=E.polygon}if(L&&L.length){for(var H=0;H<L.length;H++){J=new GLatLng(parseFloat(L[H].lat),parseFloat(L[H].lon));K.push(J);if(g.opts.centerOnItems){m.extend(J)}}if("polyline" in E){D=new GPolyline(K,z.lineColor,z.lineWeight,z.lineOpacity);G="polyline";J=D.getVertex(Math.floor(D.getVertexCount()/2))}else{D=new GPolygon(K,z.polygonLineColor,z.polygonLineWeight,z.polygonLineOpacity,z.fillColor,z.fillOpacity);G="polygon";J=D.getBounds().getCenter()}}}else{if("overlay" in E){var I=new GLatLng(parseFloat(E.overlay.south),parseFloat(E.overlay.west));var C=new GLatLng(parseFloat(E.overlay.north),parseFloat(E.overlay.east));if(g.opts.centerOnItems){m.extend(I);m.extend(C)}var i=new GLatLngBounds(I,C);D=new GGroundOverlay(E.overlay.image,i);G="overlay";J=i.getCenter()}}}return{placemark:D,type:G,point:J}};var y=[],t=[],c=null,h="",u=null,w;if("placemarks" in A){t=A.placemarks}else{var o=["point","polyline","polygon","overlay"];for(w=0;w<o.length;w++){if(o[w] in A){c={};c[o[w]]=A[o[w]];t.push(c)}}}if(t){for(w=0;w<t.length;w++){var r=s(t[w]);if(r&&r.placemark){u=u||r.point;h=h||r.type;y.push(r.placemark)}}}if(y.length>1){h="array"}options.title=B;options.type=h;if(options.infoPoint){options.infoPoint=new GLatLng(parseFloat(options.infoPoint.lat),parseFloat(options.infoPoint.lon))}else{options.infoPoint=u}var x=new TimeMapItem(y,v,this,options);if(v!==null){v.item=x;if(!this.opts.noEventLoad){this.eventSource.add(v)}}if(y.length>0){for(w=0;w<y.length;w++){y[w].item=x;GEvent.addListener(y[w],"click",function(){x.openInfoWindow()});if(!this.opts.noPlacemarkLoad){g.map.addOverlay(y[w])}y[w].hide()}}this.items.push(x);return x};function TimeMapTheme(c){var b=TimeMap.util;var e={color:"#FE766A",lineOpacity:1,lineWeight:2,fillOpacity:0.25,eventTextColor:null,eventIconPath:"timemap/images/",eventIconImage:"red-circle.png",classicTape:false,iconImage:GIP+"red-dot.png"};var d=b.merge(c,e);delete d.mergeOnly;if(!d.icon){var a=new GIcon(G_DEFAULT_ICON);a.image=d.iconImage;a.iconSize=new GSize(32,32);a.shadow=GIP+"msmarker.shadow.png";a.shadowSize=new GSize(59,32);a.iconAnchor=new GPoint(16,33);a.infoWindowAnchor=new GPoint(18,3);d.icon=a}e={lineColor:d.color,polygonLineColor:d.color,polgonLineOpacity:d.lineOpacity,polygonLineWeight:d.lineWeight,fillColor:d.color,eventColor:d.color,eventIcon:d.eventIconPath+d.eventIconImage};d=b.merge(d,e);return d}TimeMapTheme.create=function(c,a){c=TimeMap.util.lookup(c,TimeMap.themes)||new TimeMapTheme();var d={},b;for(b in c){if(c.hasOwnProperty(b)){d[b]=a[b]||c[b]}}d.eventIcon=a.eventIcon||d.eventIconPath+d.eventIconImage;return d};function TimeMapItem(c,d,f,b){var a=TimeMap.util;this.event=d;this.dataset=f;this.map=f.timemap.map;if(c&&a.isArray(c)&&c.length===0){c=null}if(c&&c.length==1){c=c[0]}this.placemark=c;var e={type:"none",title:"Untitled",description:"",infoPoint:null,infoHtml:"",infoUrl:"",closeInfoWindow:TimeMapItem.closeInfoWindowBasic};this.opts=b=a.merge(b,e,f.opts);if(!b.openInfoWindow){if(b.infoUrl!==""){b.openInfoWindow=TimeMapItem.openInfoWindowAjax}else{b.openInfoWindow=TimeMapItem.openInfoWindowBasic}}this.getType=function(){return this.opts.type};this.getTitle=function(){return this.opts.title};this.getInfoPoint=function(){return this.opts.infoPoint||this.map.getCenter()};this.visible=true;this.placemarkVisible=false;this.eventVisible=true;this.openInfoWindow=b.openInfoWindow;this.closeInfoWindow=b.closeInfoWindow}TimeMapItem.prototype.showPlacemark=function(){if(this.placemark){if(this.getType()=="array"){for(var a=0;a<this.placemark.length;a++){this.placemark[a].show()}}else{this.placemark.show()}this.placemarkVisible=true}};TimeMapItem.prototype.hidePlacemark=function(){if(this.placemark){if(this.getType()=="array"){for(var a=0;a<this.placemark.length;a++){this.placemark[a].hide()}}else{this.placemark.hide()}this.placemarkVisible=false}this.closeInfoWindow()};TimeMapItem.prototype.showEvent=function(){if(this.event){if(this.eventVisible===false){this.dataset.timemap.timeline.getBand(0).getEventSource()._events._events.add(this.event)}this.eventVisible=true}};TimeMapItem.prototype.hideEvent=function(){if(this.event){if(this.eventVisible){this.dataset.timemap.timeline.getBand(0).getEventSource()._events._events.remove(this.event)}this.eventVisible=false}};TimeMapItem.openInfoWindowBasic=function(){var a=this.opts.infoHtml;if(a===""){a='<div class="infotitle">'+this.opts.title+"</div>";if(this.opts.description!==""){a+='<div class="infodescription">'+this.opts.description+"</div>"}}if(this.placemark&&!this.visible&&this.event){var b=this.dataset.timemap.timeline.getBand(0);b.setCenterVisibleDate(this.event.getStart())}if(this.getType()=="marker"){this.placemark.openInfoWindowHtml(a)}else{this.map.openInfoWindowHtml(this.getInfoPoint(),a)}this.selected=true};TimeMapItem.openInfoWindowAjax=function(){if(this.opts.infoHtml!==""){this.openInfoWindow=TimeMapItem.openInfoWindowBasic;this.openInfoWindow()}else{if(this.opts.infoUrl!==""){var a=this;GDownloadUrl(this.opts.infoUrl,function(b){a.opts.infoHtml=b;a.openInfoWindow()})}else{this.openInfoWindow=TimeMapItem.openInfoWindowBasic;this.openInfoWindow()}}};TimeMapItem.closeInfoWindowBasic=function(){if(this.getType()=="marker"){this.placemark.closeInfoWindow()}else{var a=this.map.getInfoWindow();if(a.getPoint()==this.getInfoPoint()&&!a.isHidden()){this.map.closeInfoWindow()}}this.selected=false};TimeMap.util={};TimeMap.util.trim=function(a){a=a&&String(a)||"";return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")};TimeMap.util.isArray=function(a){return a&&!(a.propertyIsEnumerable("length"))&&typeof a==="object"&&typeof a.length==="number"};TimeMap.util.getTagValue=function(e,a,c){var d="";var b=TimeMap.util.getNodeList(e,a,c);if(b.length>0){e=b[0].firstChild;while(e!==null){d+=e.nodeValue;e=e.nextSibling}}return d};TimeMap.util.nsMap={};TimeMap.util.getNodeList=function(d,b,c){var a=TimeMap.util.nsMap;if(c===undefined){return d.getElementsByTagName(b)}if(d.getElementsByTagNameNS&&a[c]){return d.getElementsByTagNameNS(a[c],b)}return d.getElementsByTagName(c+":"+b)};TimeMap.util.makePoint=function(c,d){var b=null,a=TimeMap.util.trim;if(c.lat&&c.lng){b=[c.lat(),c.lng()]}if(TimeMap.util.isArray(c)){b=c}if(!b){c=a(c);if(c.indexOf(",")>-1){b=c.split(",")}else{b=c.split(/[\r\n\f ]+/)}}if(b.length>2){b=b.slice(0,2)}if(d){b.reverse()}return{lat:a(b[0]),lon:a(b[1])}};TimeMap.util.makePoly=function(d,f){var c=[],b;var e=TimeMap.util.trim(d).split(/[\r\n\f ]+/);if(e.length===0){return[]}for(var a=0;a<e.length;a++){b=(e[a].indexOf(",")>0)?e[a].split(","):[e[a],e[++a]];if(b.length>2){b=b.slice(0,2)}if(f){b.reverse()}c.push({lat:b[0],lon:b[1]})}return c};TimeMap.util.formatDate=function(h,g){g=g||3;var i="";if(h){if(h.toISOString){return h.toISOString()}var a=function(d){return((d<10)?"0":"")+d};var f=h.getUTCFullYear(),b=h.getUTCMonth(),j=h.getUTCDate();i+=f+"-"+a(b+1)+"-"+a(j);if(g>1){var c=h.getUTCHours(),e=h.getUTCMinutes(),k=h.getUTCSeconds();i+="T"+a(c)+":"+a(e);if(g>2){i+=a(k)}i+="Z"}}return i};TimeMap.util.TimelineVersion=function(){if(Timeline.version){return Timeline.version}if(Timeline.DurationEventPainter){return"1.2"}else{return"2.2.0"}};TimeMap.util.getPlacemarkType=function(a){if("getIcon" in a){return"marker"}if("getVertex" in a){return"setFillStyle" in a?"polygon":"polyline"}return false};TimeMap.util.merge=function(){var d={},b=arguments,f,c,a,g;var e=function(j,i,h){if(j.hasOwnProperty(h)&&i[h]===undefined){i[h]=j[h]}};for(a=0;a<b.length;a++){f=b[a];if(f){if(a>0&&"mergeOnly" in f){for(g=0;g<f.mergeOnly.length;g++){c=f.mergeOnly[g];e(f,d,c)}}else{for(c in f){e(f,d,c)}}}}return d};TimeMap.util.lookup=function(a,b){if(typeof(a)=="string"){return b[a]}else{return a}};TimeMap.intervals={sec:[DT.SECOND,DT.MINUTE],min:[DT.MINUTE,DT.HOUR],hr:[DT.HOUR,DT.DAY],day:[DT.DAY,DT.WEEK],wk:[DT.WEEK,DT.MONTH],mon:[DT.MONTH,DT.YEAR],yr:[DT.YEAR,DT.DECADE],dec:[DT.DECADE,DT.CENTURY]};TimeMap.mapTypes={normal:G_NORMAL_MAP,satellite:G_SATELLITE_MAP,hybrid:G_HYBRID_MAP,physical:G_PHYSICAL_MAP,moon:G_MOON_VISIBLE_MAP,sky:G_SKY_VISIBLE_MAP};TimeMap.dateParsers={hybrid:TimeMapDataset.hybridParser,iso8601:DT.parseIso8601DateTime,gregorian:TimeMapDataset.gregorianParser};TimeMap.themes={red:new TimeMapTheme(),blue:new TimeMapTheme({iconImage:GIP+"blue-dot.png",color:"#5A7ACF",eventIconImage:"blue-circle.png"}),green:new TimeMapTheme({iconImage:GIP+"green-dot.png",color:"#19CF54",eventIconImage:"green-circle.png"}),ltblue:new TimeMapTheme({iconImage:GIP+"ltblue-dot.png",color:"#5ACFCF",eventIconImage:"ltblue-circle.png"}),purple:new TimeMapTheme({iconImage:GIP+"purple-dot.png",color:"#8E67FD",eventIconImage:"purple-circle.png"}),orange:new TimeMapTheme({iconImage:GIP+"orange-dot.png",color:"#FF9900",eventIconImage:"orange-circle.png"}),yellow:new TimeMapTheme({iconImage:GIP+"yellow-dot.png",color:"#ECE64A",eventIconImage:"yellow-circle.png"})};if(!this.JSON){JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];if(typeof c==="string"){return c}return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(typeof value.length==="number"&&!value.propertyIsEnumerable("length")){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==="string"){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}})();TimeMap.prototype.toJSON=function(){var a={options:this.makeOptionData,datasets:this.datasets};a=this.addExportData(a);return a};TimeMap.prototype.makeOptionData=function(){var f={},g=TimeMap.util;var a=this.opts;for(var e in a){if(a.hasOwnProperty(e)){f[e]=a[e]}}if(f.mapCenter){f.mapCenter=g.makePoint(f.mapCenter)}if(f.mapType){f.mapType=g.revHash(TimeMap.mapTypes,f.mapType)}if(f.mapTypes){var d=[],b;for(var i=0;i<f.mapTypes.length;i++){b=g.revHash(TimeMap.mapTypes,f.mapTypes[i]);if(b){d.push(b)}}f.mapTypes=d}if(f.bandIntervals){f.bandIntervals=g.revHash(TimeMap.intervals,f.bandIntervals)}var h=[],j,c;for(c in this.datasets){if(this.datasets.hasOwnProperty(c)){j=g.revHash(TimeMapDataset.themes,this.datasets[c].opts.theme);if(j){h.push(j)}}}f.themes=j;return f};TimeMap.prototype.addExportData=function(a){a.options=a.options||{};a.options.saveOpts=this.opts.saveOpts;return a};TimeMapDataset.prototype.toJSON=function(){var a={title:this.getTitle(),theme:TimeMap.util.revHash(TimeMapDataset.themes,this.opts.theme),data:{type:"basic",value:this.getItems()}};a=this.addExportData(a);return a};TimeMapDataset.prototype.addExportData=function(a){a.options=a.options||{};a.options.saveOpts=this.opts.saveOpts;return a};TimeMapItem.prototype.toJSON=function(){var d={title:this.getTitle(),options:{description:this.opts.description}};if(this.event){d.start=this.event.getStart();if(!this.event.isInstant()){d.end=this.event.getEnd()}}if(this.placemark){var a=TimeMap.util;var c=function(h,g,i){h=h||a.getPlacemarkType(g);switch(h){case"marker":i.point=a.makePoint(g.getLatLng());break;case"polyline":case"polygon":var f=[];for(var e=0;e<g.getVertexCount();e++){f.push(a.makePoint(g.getVertex(e)))}i[h]=f;break}return i};if(this.getType()=="array"){d.placemarks=[];for(var b=0;b<this.placemark.length;b++){d.placemarks.push(c(false,this.placemark[b],{}))}}else{d=c(this.getType(),this.placemark,d)}}d=this.addExportData(d);return d};TimeMapItem.prototype.addExportData=function(a){a.options=a.options||{};a.options.saveOpts=this.opts.saveOpts;return a};TimeMap.util.revHash=function(b,c){for(var a in b){if(b[a]==c){return a}}return null};TimeMap.prototype.clear=function(){this.each(function(a){a.clear()});this.datasets=[]};TimeMap.prototype.deleteDataset=function(a){this.datasets[a].clear();delete this.datasets[a]};TimeMap.prototype.hideDataset=function(a){if(a in this.datasets){this.datasets[a].hide()}};TimeMap.prototype.hideDatasets=function(){this.each(function(a){a.visible=false});this.filter("map");this.filter("timeline");this.timeline.layout()};TimeMap.prototype.showDataset=function(a){if(a in this.datasets){this.datasets[a].show()}};TimeMap.prototype.showDatasets=function(){this.each(function(a){a.visible=true});this.filter("map");this.filter("timeline");this.timeline.layout()};TimeMap.prototype.changeMapType=function(a){if(a==this.opts.mapType){return}if(typeof(a)=="string"){a=TimeMap.mapTypes[a]}if(!a){return}this.opts.mapType=a;this.map.setMapType(a)};TimeMap.prototype.refreshTimeline=function(){var b=this.timeline.getBand(0);var a=b.getCenterVisibleDate();if(TimeMap.util.TimelineVersion()=="1.2"){b.getEventPainter().getLayout()._laidout=false}this.timeline.layout();b.setCenterVisibleDate(a)};TimeMap.prototype.changeTimeIntervals=function(c){if(c==this.opts.bandIntervals){return}if(typeof(c)=="string"){c=TimeMap.intervals[c]}if(!c){return}this.opts.bandIntervals=c;var d=function(g,f){g.getEther()._interval=Timeline.DateTime.gregorianUnitLengths[f];g.getEtherPainter()._unit=f};var e=this.timeline.getBand(0);var b=e.getCenterVisibleDate();for(var a=0;a<this.timeline.getBandCount();a++){d(this.timeline.getBand(a),c[a])}e.getEventPainter().getLayout()._laidout=false;this.timeline.layout();e.setCenterVisibleDate(b)};TimeMap.prototype.scrollTimeline=function(b){var d=this.timeline.getBand(0);var a=d.getCenterVisibleDate();var c=a.getFullYear()+parseFloat(b);a.setFullYear(c);d.setCenterVisibleDate(a)};TimeMapDataset.prototype.clear=function(){this.each(function(a){a.clear()});this.items=[];this.timemap.timeline.layout()};TimeMapDataset.prototype.deleteItem=function(b){for(var a=0;a<this.items.length;a++){if(this.items[a]==b){b.clear();this.items.splice(a,1);break}}this.timemap.timeline.layout()};TimeMapDataset.prototype.show=function(){if(!this.visible){this.visible=true;this.timemap.filter("map");this.timemap.filter("timeline");this.timemap.timeline.layout()}};TimeMapDataset.prototype.hide=function(){if(this.visible){this.visible=false;this.timemap.filter("map");this.timemap.filter("timeline");this.timemap.timeline.layout()}};TimeMapDataset.prototype.changeTheme=function(a){this.opts.theme=a;this.each(function(b){b.changeTheme(a)});this.timemap.timeline.layout()};TimeMapItem.prototype.show=function(){this.showEvent();this.showPlacemark();this.visible=true};TimeMapItem.prototype.hide=function(){this.hideEvent();this.hidePlacemark();this.visible=false};TimeMapItem.prototype.clear=function(){if(this.event){this.dataset.timemap.timeline.getBand(0).getEventSource()._events._events.remove(this.event)}if(this.placemark){this.hidePlacemark();var b=function(d){try{this.map.removeOverlay(d)}catch(c){}};if(this.getType()=="array"){for(var a=0;a<this.placemark.length;a++){b(this.placemark[a])}}else{b(this.placemark)}}this.event=this.placemark=null};TimeMapItem.prototype.createEvent=function(b,d){var a=(d===undefined);var f=this.getTitle();var c=new Timeline.DefaultEventSource.Event(b,d,null,null,a,f,null,null,null,this.opts.theme.eventIcon,this.opts.theme.eventColor,null);c.item=this;this.event=c;this.dataset.eventSource.add(c)};TimeMapItem.prototype.changeTheme=function(c){this.opts.theme=c;if(this.placemark){var b=function(d,e,f){e=e||TimeMap.util.getPlacemarkType(d);switch(e){case"marker":d.setImage(f.icon.image);break;case"polygon":d.setFillStyle({color:c.fillColor,opacity:c.fillOpacity});case"polyline":d.setStrokeStyle({color:c.lineColor,weight:c.lineWeight,opacity:c.lineOpacity});break}};if(this.getType()=="array"){for(var a=0;a<this.placemark.length;a++){b(this.placemark[a],false,c)}}else{b(this.placemark,this.getType(),c)}}if(this.event){this.event._color=c.eventColor;this.event._icon=c.eventIcon}};TimeMapItem.prototype.getNextPrev=function(a,b){if(!this.event){return}var e=this.dataset.timemap.timeline.getBand(0).getEventSource();var c=a?e.getEventReverseIterator(new Date(e.getEarliestDate().getTime()-1),this.event.getStart()):e.getEventIterator(this.event.getStart(),new Date(e.getLatestDate().getTime()+1));var d=null;while(d===null){if(c.hasNext()){d=c.next().item;if(b&&d.dataset!=this.dataset){d=null}}else{break}}return d};TimeMapItem.prototype.getNext=function(a){return this.getNextPrev(false,a)};TimeMapItem.prototype.getPrev=function(a){return this.getNextPrev(true,a)};TimeMap.loaders.flickr=function(b){var a=new TimeMap.loaders.jsonp(b);a.preload=function(c){return c.items};a.transform=function(d){var c={title:d.title,start:d.date_taken,point:{lat:d.latitude,lon:d.longitude},options:{description:d.description.replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"')}};if(b.transformFunction){c=b.transformFunction(c)}return c};return a};TimeMap.loaders.georss=function(b){var a=new TimeMap.loaders.remote(b);a.parse=TimeMap.loaders.georss.parse;return a};TimeMap.loaders.georss.parse=function(n){var j=[],w,l,f,r;l=GXml.parse(n);var a=TimeMap.util;var c=a.getTagValue,s=a.getNodeList,p=a.makePoint,b=a.makePoly,g=a.formatDate,e=a.nsMap;e.georss="http://www.georss.org/georss";e.gml="http://www.opengis.net/gml";e.geo="http://www.w3.org/2003/01/geo/wgs84_pos#";e.kml="http://www.opengis.net/kml/2.2";var u=(l.firstChild.tagName=="rss")?"rss":"atom";var q=(u=="rss"?"item":"entry");f=s(l,q);for(var o=0;o<f.length;o++){r=f[o];w={options:{}};w.title=c(r,"title");q=(u=="rss"?"description":"summary");w.options.description=c(r,q);var v=s(r,"TimeStamp","kml");if(v.length>0){w.start=c(v[0],"when","kml")}if(!w.start){v=s(r,"TimeSpan","kml");if(v.length>0){w.start=c(v[0],"begin","kml");w.end=c(v[0],"end","kml")||g(new Date())}}if(!w.start){if(u=="rss"){var t=new Date(Date.parse(c(r,"pubDate")));w.start=g(t)}else{w.start=c(r,"updated")}}var h=false;PLACEMARK:while(!h){var m,k;m=c(r,"point","georss");if(m){w.point=p(m);break PLACEMARK}v=s(r,"Point","gml");if(v.length>0){m=c(v[0],"pos","gml");if(!m){m=c(v[0],"coordinates","gml")}if(m){w.point=p(m);break PLACEMARK}}if(c(r,"lat","geo")){m=[c(r,"lat","geo"),c(r,"long","geo")];w.point=p(m);break PLACEMARK}m=c(r,"line","georss");if(m){w.polyline=b(m);break PLACEMARK}m=c(r,"polygon","georss");if(m){w.polygon=b(m);break PLACEMARK}v=s(r,"LineString","gml");if(v.length>0){k="polyline"}else{v=s(r,"Polygon","gml");if(v.length>0){k="polygon"}}if(v.length>0){m=c(v[0],"posList","gml");if(!m){m=c(v[0],"coordinates","gml")}if(m){w[k]=b(m);break PLACEMARK}}h=true}j.push(w)}l=null;f=null;r=null;v=null;return j};TimeMap.loaders.gss=function(b){var a=new TimeMap.loaders.jsonp(b);if(!a.url){a.url="http://spreadsheets.google.com/feeds/list/"+b.key+"/1/public/values?alt=json-in-script&callback="}a.map=b.map;a.preload=function(c){return c.feed.entry};a.transform=function(g){var e=a.map||TimeMap.loaders.gss.map;var d=function(h){if(h in e&&e[h]){return g["gsx$"+e[h]].$t}else{return false}};var f={title:d("title"),start:d("start"),end:d("end"),point:{lat:d("lat"),lon:d("lon")},options:{description:d("description")}};var c=b.transformFunction;if(c){f=c(f)}return f};return a};TimeMap.loaders.gss.map={title:"title",description:"description",start:"start",end:"end",lat:"lat",lon:"lon"};TimeMap.loaders.jsonp=function(a){TimeMap.loaders.mixin(this,a);this.url=a.url};TimeMap.loaders.jsonp.prototype.load=function(b,c){var a=this;TimeMap.loaders.jsonp.read(this.url,function(d){var e=a.preload(d);b.loadItems(e,a.transform);c()})};TimeMap.loaders.jsonp.counter=0;TimeMap.loaders.jsonp.read=function(b,c){var d="_"+TimeMap.loaders.jsonp.counter++;TimeMap.loaders.jsonp[d]=function(e){c(e);delete TimeMap.loaders.jsonp[d]};var a=document.createElement("script");a.src=b+"TimeMap.loaders.jsonp."+d;document.body.appendChild(a)};TimeMap.loaders.json_string=function(b){var a=new TimeMap.loaders.remote(b);a.parse=JSON.parse;return a};TimeMap.loaders.json=TimeMap.loaders.jsonp;TimeMap.loaders.kml=function(b){var a=new TimeMap.loaders.remote(b);a.parse=TimeMap.loaders.kml.parse;return a};TimeMap.loaders.kml.parse=function(t){var g=[],s,n,e,o,l,h;n=GXml.parse(t);var a=TimeMap.util;var c=a.getTagValue,q=a.getNodeList,m=a.makePoint,b=a.makePoly,f=a.formatDate;var d=function(w,v){var i=false;var u=q(w,"TimeStamp");if(u.length>0){v.start=c(u[0],"when");i=true}else{u=q(w,"TimeSpan");if(u.length>0){v.start=c(u[0],"begin");v.end=c(u[0],"end")||f(new Date());i=true}}if(!i){var j=w.parentNode;if(j.nodeName=="Folder"||j.nodeName=="Document"){d(j,v)}j=null}};e=q(n,"Placemark");for(l=0;l<e.length;l++){o=e[l];s={options:{}};s.title=c(o,"name");s.options.description=c(o,"description");d(o,s);var r,k,p;s.placemarks=[];r=q(o,"Point");for(h=0;h<r.length;h++){p={point:{}};k=c(r[h],"coordinates");p.point=m(k,1);s.placemarks.push(p)}r=q(o,"LineString");for(h=0;h<r.length;h++){p={polyline:[]};k=c(r[h],"coordinates");p.polyline=b(k,1);s.placemarks.push(p)}r=q(o,"Polygon");for(h=0;h<r.length;h++){p={polygon:[]};k=c(r[h],"coordinates");p.polygon=b(k,1);s.placemarks.push(p)}g.push(s)}e=q(n,"GroundOverlay");for(l=0;l<e.length;l++){o=e[l];s={options:{},overlay:{}};s.title=c(o,"name");s.options.description=c(o,"description");d(o,s);r=q(o,"Icon");s.overlay.image=c(r[0],"href");r=q(o,"LatLonBox");s.overlay.north=c(r[0],"north");s.overlay.south=c(r[0],"south");s.overlay.east=c(r[0],"east");s.overlay.west=c(r[0],"west");g.push(s)}n=null;e=null;o=null;r=null;return g};TimeMap.loaders.metaweb=function(b){var a=new TimeMap.loaders.jsonp(b);a.HOST=b.host||"http://www.freebase.com";a.QUERY_SERVICE=b.service||"/api/service/mqlread";a.preload=function(f){var g=f.qname;if(g.code.indexOf("/api/status/ok")!==0){return[]}var e=g.result;return e};var d=b.query||{};var c=encodeURIComponent(JSON.stringify({qname:{query:d}}));a.url=a.HOST+a.QUERY_SERVICE+"?queries="+c+"&callback=";return a};